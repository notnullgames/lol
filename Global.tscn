[gd_scene load_steps=4 format=2]

[ext_resource path="res://images/window.9.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends CanvasLayer

var current_scene = null

# global used to check if player can move
var player_can_move = true

# show a dialog box
func show_dialog(name, text, name_align=\"left\"):
	return $DialogControl.show_dialog(name, text, name_align)

# switch scenes
func goto_scene(path):
	call_deferred(\"_deferred_goto_scene\", path)

func _deferred_goto_scene(path):
	current_scene.free()
	var s = ResourceLoader.load(path)
	current_scene = s.instance()
	get_tree().get_root().add_child(current_scene)
	get_tree().set_current_scene(current_scene)

func _ready():
	var root = get_tree().get_root()
	current_scene = root.get_child(root.get_child_count() - 1)
"

[sub_resource type="GDScript" id=2]
script/source = "# DialogControl

extends Control

var scroll = 0
onready var font = $NinePatchRect/Text.get_font(\"normal_font\")
onready var window_size = $NinePatchRect/Text.get_size()
onready var font_height = font.get_height()
onready var lines_per_page = int(floor(window_size[1] / font_height))

# handle Dialog input
func _input(event):
	if self.visible:
		if event.is_action_pressed(\"ui_accept\"):
			scroll = scroll + lines_per_page
			if scroll >= $NinePatchRect/Text.get_line_count():
				self.visible = false
				Global.player_can_move = true
			else:
				$NinePatchRect/Text.scroll_to_line(scroll)
		if event.is_action_pressed(\"ui_cancel\"):
			self.visible = false
			Global.player_can_move = true

func _ready():
	self.visible = false

# this is exposed for Global.show_dialog
func show_dialog(name, text, name_align):
	# The next-page is triggered, so I set scroll to negative 1-page
	scroll = -1 * lines_per_page
	self.visible = true
	Global.player_can_move = false
	if name_align == \"left\":
		$Name.bbcode_text = name
	if name_align == \"right\":
		$Name.bbcode_text = \"[right]%s[/right]\" % name
	if name_align == \"center\":
		$Name.bbcode_text = \"[center]%s[/center]\" % name
	$NinePatchRect/Text.bbcode_text = text
	$NinePatchRect/Text.scroll_to_line(scroll)
	# add newlines to the end to make scroll work right
	var newlinecount = (lines_per_page % int($NinePatchRect/Text.get_line_count())) - 1
	$NinePatchRect/Text.bbcode_text += \"\\n\".repeat(newlinecount)
	return self
"

[node name="Global" type="CanvasLayer"]
script = SubResource( 1 )

[node name="DialogControl" type="Control" parent="."]
margin_left = 4.49011
margin_top = 152.125
margin_right = 310.49
margin_bottom = 238.125
script = SubResource( 2 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="NinePatchRect" type="NinePatchRect" parent="DialogControl"]
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -152.0
margin_top = -41.5
margin_right = 152.0
margin_bottom = 41.5
texture = ExtResource( 2 )
region_rect = Rect2( 1.05211, 1.42795, 191.737, 63.2099 )
patch_margin_left = 36
patch_margin_top = 14
patch_margin_right = 33
patch_margin_bottom = 13
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Text" type="RichTextLabel" parent="DialogControl/NinePatchRect"]
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
margin_left = -144.0
margin_top = -30.0
margin_right = 144.0
margin_bottom = 30.0
bbcode_enabled = true
tab_size = 2
scroll_active = false
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Name" type="RichTextLabel" parent="DialogControl"]
anchor_left = 0.5
anchor_right = 0.5
margin_left = -147.5
margin_top = -12.0
margin_right = 145.5
margin_bottom = 3.0
size_flags_horizontal = 0
size_flags_vertical = 0
bbcode_enabled = true
bbcode_text = "Name"
text = "Name"
scroll_active = false
__meta__ = {
"_edit_use_anchors_": false
}
